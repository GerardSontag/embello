Maximal CPM 2.2 BIOS for eZ80 -jcw, 2017-03-17 Z80ASM 1.32 Page   1
MAXBIOS Z80

    2                   
    3                   ; memory map -------------------------------------------------------------------
    4                   
    5         E400      CCP     equ 0E400h
    6         EC06      BDOS    equ CCP + 0806h
    7         FA00      BIOS    equ CCP + 1600h
    8                   
    9         0020      BANK	equ 20h     ; SRAM and MBASE are set to this bank
   10         003A      FROM	equ 3Ah     ; bank from which to copy everything
   11         6000      FOFF	equ 6000h   ; starting page offset in FROM area
   12                   
   13                   ; low memory -------------------------------------------------------------------
   14                   
   15         0003      iobyte  equ 03h     ; Intel standard I/O definition byte
   16         0004      usrdrv  equ 04h     ; Current user number and drive
   17         0080      tpabuf  equ 0080h   ; Default I/O buffer and command line storage
   18                   
   19         FA00               org BIOS
   20                   
   21                   ; BIOS jump table --------------------------------------------------------------
   22                   
   23 FA00  C3 FA91     	jp boot     ;  0 Initialize
   24 FA03  C3 FAB9     wboote: jp wboot    ;  1 Warm boot
   25 FA06  C3 FAF3     	jp conist   ;  2 Console status
   26 FA09  C3 FAFB     	jp conin    ;  3 Console input
   27 FA0C  C3 FB04     	jp conout   ;  4 Console OUTput
   28 FA0F  C3 FB71     	jp list     ;  5 List OUTput
   29 FA12  C3 FB71     	jp punch    ;  6 punch OUTput
   30 FA15  C3 FB0F     	jp reader   ;  7 Reader input
   31 FA18  C3 FB30     	jp home     ;  8 Home disk
   32 FA1B  C3 FB12     	jp seldsk   ;  9 Select disk
   33 FA1E  C3 FB32     	jp settrk   ; 10 Select track
   34 FA21  C3 FB37     	jp setsec   ; 11 Select sector
   35 FA24  C3 FB3C     	jp setdma   ; 12 Set DMA ADDress
   36 FA27  C3 FB44     	jp read     ; 13 Read 128 bytes
   37 FA2A  C3 FB58     	jp write    ; 14 Write 128 bytes
   38 FA2D  C3 FB71     	jp listst   ; 15 List status
   39 FA30  C3 FB41     	jp sectrn   ; 16 Sector translate
   40                   
   41                   ; Disk Parameter Headers -------------------------------------------------------
   42                   
   43 FA33  0000  0000  dpbase:	dw 0,0,0,0,dirbuf,dpb0,0,alv0   ; A: is RAM disk @ 36h
   44 FA43  0000  0000  	dw 0,0,0,0,dirbuf,dpb1,0,alv1   ; B: is flash @ 00h
   45 FA53  0000  0000  	dw 0,0,0,0,dirbuf,dpb1,0,alv1   ; C: is for future use
   46 FA63  0000  0000  	dw 0,0,0,0,dirbuf,dpb1,0,alv2   ; D: is remote disk
   47                   
   48 FA73  001A        dpb0:	dw 26  ; SPT - sectors per track
   49 FA75  03          	db 3   ; BSH - block shift factor
   50 FA76  07          	db 7   ; BLM - block mask
   51 FA77  00          	db 0   ; EXM - Extent mask
   52 FA78  00F8        	dw 248 ; DSM - Storage size (blocks - 1)
   53 FA7A  003F        	dw 63  ; DRM - Number of directory entries - 1
   54 FA7C  C0          	db 192 ; AL0 - 1 bit set per directory block
   55 FA7D  00          	db 0   ; AL1 - ... 8 more bits
   56 FA7E  0000        	dw 0   ; CKS - DIR check vector size (DRM+1)/4 (0=fixed disk)
   57 FA80  0002        	dw 2   ; OFF - Reserved tracks
   58                   
   59 FA82  001A        dpb1:	dw 26  ; SPT - sectors per track
Maximal CPM 2.2 BIOS for eZ80 -jcw, 2017-03-17 Z80ASM 1.32 Page   2
MAXBIOS Z80

   60 FA84  03          	db 3   ; BSH - block shift factor
   61 FA85  07          	db 7   ; BLM - block mask
   62 FA86  00          	db 0   ; EXM - Extent mask
   63 FA87  00F8        	dw 248 ; DSM - Storage size (blocks - 1)
   64 FA89  003F        	dw 63  ; DRM - Number of directory entries - 1
   65 FA8B  C0          	db 192 ; AL0 - 1 bit set per directory block
   66 FA8C  00          	db 0   ; AL1 - ... 8 more bits
   67 FA8D  0000        	dw 0   ; CKS - DIR check vector size (DRM+1)/4 (0=fixed disk)
   68 FA8F  0002        	dw 2   ; OFF - Reserved tracks
   69                   
   70                   ; Cold boot --------------------------------------------------------------------
   71                   
   72 FA91  F3          boot:	di
   73 FA92  31 0100     	ld sp,0100h
   74 FA95  21 FA00     	ld hl,BIOS
   75 FA98  22 FFFE     	ld (0FFFEh),hl
   76                   
   77                   	; initialise UART0 to 9600 baud
   78                   
   79 FA9B  21 0380     	ld hl,0380h
   80 FA9E  11 1A06     	ld de,1A06h
   81 FAA1  ED 21 A5    	db 0EDh,21h,0A5h        ; out0 (0A5h),h = 03h
   82 FAA4  ED 29 C3    	db 0EDh,29h,0C3h        ; out0 (0C3h),l = 80h
   83 FAA7  ED 11 C0    	db 0EDh,11h,0C0h        ; out0 (0C0h),d = 1Ah
   84 FAAA  ED 21 C3    	db 0EDh,21h,0C3h        ; out0 (0C3h),h = 03h
   85 FAAD  ED 19 C2    	db 0EDh,19h,0C2h        ; out0 (0C2h),e = 06h
   86                   
   87 FAB0  AF          	xor a
   88 FAB1  32 0003     	ld (iobyte),a
   89 FAB4  32 0004     	ld (usrdrv),a
   90 FAB7  18 16       	jr gocpm
   91                   
   92                   ; Warm boot --------------------------------------------------------------------
   93                   
   94 FAB9  F3          wboot:	di
   95 FABA  31 0100     	ld sp,0100h
   96                   
   97                   	; copy 5.5K from {FROM,FOFF+0100h} to {BANK,CCP} to reload CCP
   98                   
   99 FABD  5B 21       	db 5Bh,21h              ; ld.lil hl,{FROM,FOFF+0100h}
  100 FABF  6100        	dw FOFF+0100h
  101 FAC1  3A          	db FROM
  102 FAC2  5B 11       	db 5Bh,11h              ; ld.lil de,{BANK,CCP}
  103 FAC4  E400        	dw CCP
  104 FAC6  20          	db BANK
  105 FAC7  5B 01       	db 5Bh,01h              ; ld.lil bc,BIOS-CCP
  106 FAC9  1600        	dw BIOS-CCP
  107 FACB  00          	db 0
  108 FACC  49 ED B0    	db 49h,0EDh,0B0h        ; ldir.l
  109                   
  110                   ; Common code for cold and warm boot
  111                   
  112 FACF  21 0080     gocpm:	ld hl,tpabuf            ; Address of BIOS DMA buffer
  113 FAD2  22 FC07     	ld (dmaadr),hl
  114                   
  115 FAD5  CD FBC0     	call finit
  116                   
  117 FAD8  3E C3       	ld a,0C3h               ; Opcode for 'JP'
Maximal CPM 2.2 BIOS for eZ80 -jcw, 2017-03-17 Z80ASM 1.32 Page   3
MAXBIOS Z80

  118 FADA  32 0000     	LD (00h),a              ; Load at start of RAM
  119 FADD  21 FA03     	ld hl,wboote            ; Address of jump for a warm boot
  120 FAE0  22 0001     	ld (01h),hl
  121 FAE3  32 0005     	ld (05h),a              ; Opcode for 'JP'
  122 FAE6  21 EC06     	ld hl,BDOS              ; Address of jump for the BDOS
  123 FAE9  22 0006     	ld (06h),hl
  124 FAEC  3A 0004     	ld a,(usrdrv)           ; Save new drive number (0)
  125 FAEF  4F          	ld c,a                  ; Pass drive number in C
  126 FAF0  C3 E400     	jp CCP                  ; Start CP/M by jumping to the CCP
  127                   
  128                   ; Console I/O ------------------------------------------------------------------
  129                   
  130 FAF3  ED 38 C5    conist:	db 0EDh,38h,0C5h ; in0 a,(0C5h)
  131 FAF6  E6 01       	and 01h
  132 FAF8  ED 44       	neg
  133 FAFA  C9          	ret
  134                   
  135 FAFB  CD FAF3     conin:	call conist
  136 FAFE  28 FB       	jr z,conin
  137 FB00  ED 38 C0    	db 0EDh,38h,0C0h        ; in0 a,(0C0h)
  138 FB03  C9          	ret
  139                   
  140 FB04  ED 38 C5    conout:	db 0EDh,38h,0C5h        ; in0 a,(0C5h)
  141 FB07  E6 20       	and 20h
  142 FB09  28 F9       	jr z,conout
  143 FB0B  ED 09 C0    	db 0EDh,09h,0C0h        ; out0 (0C0h),c
  144 FB0E  C9          	ret
  145                   
  146 FB0F  3E 1A       reader:	ld a,1Ah
  147 FB11  C9          	ret
  148                   
  149                   ; Disk I/O ---------------------------------------------------------------------
  150                   
  151 FB12  79          seldsk: ld a,c
  152 FB13  FE 04       	cp 4
  153 FB15  30 0C               jr nc,baddsk
  154 FB17  06 10               ld b,16
  155 FB19  ED 4C       	db 0EDh,4Ch ; mlt bc
  156 FB1B  21 FA33             ld hl,dpbase
  157 FB1E  09                  add hl,bc
  158 FB1F  32 FC0D     savdsk:	ld (sekdsk),a
  159 FB22  C9                  ret
  160                   
  161 FB23  21 0000     baddsk: ld hl,0
  162 FB26  3A 0004             ld a,(usrdrv)
  163 FB29  91                  sub a,c
  164 FB2A  C0                  ret nz
  165 FB2B  32 0004             ld (usrdrv),a
  166 FB2E  18 EF               jr savdsk
  167                   
  168 FB30  0E 00       home:	ld c,0
  169 FB32  79          settrk: ld a,c
  170 FB33  32 FC0E     	ld (sektrk),a
  171 FB36  C9                  ret
  172                   
  173 FB37  ED 43 FC0F  setsec: ld (seksec),bc
  174 FB3B  C9                  ret
  175                   
Maximal CPM 2.2 BIOS for eZ80 -jcw, 2017-03-17 Z80ASM 1.32 Page   4
MAXBIOS Z80

  176 FB3C  ED 43 FC07  setdma: ld (dmaadr),bc
  177 FB40  C9                  ret
  178                   
  179 FB41  69          sectrn: ld l,c
  180 FB42  60          	ld h,b
  181 FB43  C9                  ret
  182                   
  183 FB44  CD FBE4     read:	call rwaddr
  184                   
  185 FB47  FE 03               cp 3
  186 FB49  28 2B               jr z,fread
  187                   
  188 FB4B  5B 2A       	db 5Bh,2Ah              ; ld.lil hl,({BANK,dskadr})
  189 FB4D  FC0A        	dw dskadr
  190 FB4F  20          	db BANK
  191 FB50  5B ED 5B    	db 5Bh,0EDh,5Bh         ; ld.lil de,({BANK,dmaadr})
  192 FB53  FC07        	dw dmaadr
  193 FB55  20          	db BANK
  194                   
  195 FB56  18 11       	jr rwop
  196                   
  197 FB58  CD FBE4     write:	call rwaddr
  198                   
  199 FB5B  B7                  or a			; only A: is writable
  200 FB5C  20 15               jr nz,wfail
  201                   
  202 FB5E  5B 2A       	db 5Bh,2Ah              ; ld.lil hl,({BANK,dmaadr})
  203 FB60  FC07        	dw dmaadr
  204 FB62  20          	db BANK
  205 FB63  5B ED 5B    	db 5Bh,0EDh,5Bh         ; ld.lil de,({BANK,dskadr})
  206 FB66  FC0A        	dw dskadr
  207 FB68  20          	db BANK
  208                   
  209 FB69  5B 01 80 00 rwop:	db 5Bh,01h,80h,00h,00h  ; ld.lil bc,000080h
  210 FB6E  49 ED B0    	db 49h,0EDh,0B0h        ; ldir.l
  211                   
  212 FB71              listst:
  213 FB71              list:
  214 FB71              punch:
  215 FB71  AF          	xor a
  216 FB72  C9          	ret
  217                   
  218 FB73  3E FF       wfail:	ld a,0FFh
  219 FB75  C9          	ret
  220                   
  221         009A      PB_DR	equ 9Ah
  222         009B      PB_DDR	equ 9Bh
  223         009C      PB_ALT1	equ 9Ch
  224         009D      PB_ALT2	equ 9Dh
  225                   
  226         00B8      SPI_BRGL equ 0B8h
  227         00B9      SPI_BRGH equ 0B9h
  228         00BA      SPI_CTL  equ 0BAh
  229         00BB      SPI_SR   equ 0BBh
  230         00BC      SPI_TSR  equ 0BCh
  231         00BC      SPI_RBR  equ 0BCh
  232                   
  233 FB76  CD FBA4     fread:  call fidle		; wait until idle
Maximal CPM 2.2 BIOS for eZ80 -jcw, 2017-03-17 Z80ASM 1.32 Page   5
MAXBIOS Z80

  234 FB79  CD FBB4             call fxfer		; 0 = read request (seldsk)
  235 FB7C  3A FC0A             ld a,(dskadr)		; 1 = offset, bits 7..0
  236 FB7F  CD FBB4             call fxfer
  237 FB82  7D                  ld a,l
  238 FB83  CD FBB4             call fxfer		; 2 = offset, bits 15..8
  239 FB86  7C                  ld a,h
  240 FB87  CD FBB4             call fxfer		; 3 = offset, bits 23..16
  241 FB8A  CD FBA4             call fidle		; wait until idle
  242 FB8D  2A FC07     	ld hl,(dmaadr)
  243 FB90  06 80       	ld b,128
  244 FB92  AF          	xor a
  245 FB93  CD FBB4     fread1:	call fxfer		; 1..128 = read data
  246 FB96  77          	ld (hl),a
  247 FB97  23          	inc hl
  248 FB98  10 F9       	djnz fread1
  249 FB9A  AF          	xor a
  250 FB9B  ED 08 9A    fstop:	db 0EDh,08h,PB_DR	; in0 c,(PB_DR)
  251 FB9E  CB C1       	set 0,c			; set NSS high (PB0)
  252 FBA0  ED 09 9A    	db 0EDh,09h,PB_DR	; out0 (PB_DR),c
  253 FBA3  C9                  ret
  254                   
  255 FBA4  CD FB9B     fidle:	call fstop
  256                   	; TODO may need a delay here...
  257 FBA7  ED 08 9A    fidle1:	db 0EDh,08h,PB_DR	; in0 c,(PB_DR)
  258 FBAA  CB 49       	bit 1,c			; test BUSY (PB1)
  259 FBAC  20 F9       	jr nz,fidle1		; reply is not zero, repeat
  260 FBAE  CB 81       	res 0,c			; set NSS low (PB0)
  261 FBB0  ED 09 9A    	db 0EDh,09h,PB_DR	; out0 (PB_DR),c
  262 FBB3  C9          	ret
  263                   
  264 FBB4  ED 39 BC    fxfer:	db 0EDh,39h,SPI_TSR	; out0 (SPI_TSR),a
  265 FBB7  ED 38 BB    fxfer1:	db 0EDh,38h,SPI_SR	; in0 a,(SPI_SR)
  266 FBBA  28 FB       	jr z,fxfer1
  267 FBBC  ED 38 BC    	db 0EDh,38h,SPI_RBR	; in0 a,(SPI_RBR)
  268 FBBF  C9                  ret
  269                   
  270 FBC0  3E 89       finit:	ld a,89h
  271 FBC2  ED 39 9A    	db 0EDh,39h,PB_DR	; out0 (PB_DR),a
  272 FBC5  3E CE       	ld a,0CEh
  273 FBC7  ED 39 9B    	db 0EDh,39h,PB_DDR	; out0 (PB_DDR),a
  274 FBCA  3E 00       	ld a,00h
  275 FBCC  ED 39 9C    	db 0EDh,39h,PB_ALT1	; out0 (PB_ALT1),a
  276 FBCF  3E CC       	ld a,0CCh
  277 FBD1  ED 39 9D    	db 0EDh,39h,PB_ALT2	; out0 (PB_ALT2),a
  278 FBD4  3E 00       	ld a,00H
  279 FBD6  ED 39 B9    	db 0EDh,39h,SPI_BRGH	; out0 (SPI_BRG_H),a
  280 FBD9  3E 03       	ld a,03h
  281 FBDB  ED 39 B8    	db 0EDh,39h,SPI_BRGL	; out0 (SPI_BRG_L),a
  282 FBDE  3E 30       	ld a,30h
  283 FBE0  ED 39 BA    	db 0EDh,39h,SPI_CTL	; out0 (SPI_CTL),a
  284 FBE3  C9          	ret
  285                   
  286                   ; Convert selected disk+track+sector to a memory address
  287                   
  288 FBE4  ED 4B FC0E  rwaddr:	ld bc,(sektrk)
  289 FBE8  06 1A       	ld b,26
  290 FBEA  ED 4C       	db 0EDh,4Ch ; mlt bc
  291                   	; BC = track, converted to linear sector offset
Maximal CPM 2.2 BIOS for eZ80 -jcw, 2017-03-17 Z80ASM 1.32 Page   6
MAXBIOS Z80

  292 FBEC  2A FC0F     	ld hl,(seksec)
  293 FBEF  09          	add hl,bc
  294                   	; HL = bits 30..23 of the requested disk block address
  295 FBF0  AF          	xor a
  296 FBF1  CB 1C       	rr h
  297 FBF3  CB 1D       	rr l
  298 FBF5  1F          	rra
  299                   	; A = bits 7..0 of the 24-bit disk-block address
  300 FBF6  32 FC0A     	ld (dskadr),a
  301                   	; add the disk base to bits 23..16, if drive A:
  302 FBF9  3A FC0D             ld a,(sekdsk)
  303 FBFC  B7                  or a
  304 FBFD  20 04               jr nz,rwflsh
  305 FBFF  01 3A60     	ld bc,FROM*256+(FOFF/256)
  306 FC02  09          	add hl,bc
  307 FC03              rwflsh: ; HL = bits 23..8 of the 24-bit disk-block address
  308 FC03  22 FC0B     	ld (dskadr+1),hl
  309 FC06  C9          	ret
  310                   
  311                   ; Data area --------------------------------------------------------------------
  312                   
  313 FC07  80 00 20    dmaadr: db 80h,00h,BANK ; last dma address + bank
  314                   
  315                   ; End of initialised data
  316                   
  317 FC0A    0003      dskadr: ds 3   ; disk address + bank
  318                   
  319 FC0D    0001      sekdsk: ds 1   ; seek disk number
  320 FC0E    0001      sektrk: ds 1   ; seek track number
  321 FC0F    0002      seksec: ds 2   ; seek sector number
  322                   
  323 FC11    0080      dirbuf: ds 128 ; scratch directory area
  324 FC91    0020      alv0:   ds 32  ; allocation vector 0 (max 255 blocks)
  325 FCB1    0020      alv1:   ds 32  ; allocation vector 1 (max 255 blocks)
  326 FCD1    0020      alv2:   ds 32  ; allocation vector 1 (max 255 blocks)
  327                   
  328         FCF1      biosEnd equ $ ; ----------------------------------------------------------------
  329                   
  330                           end
 0 Error(s) Detected.
 753 Absolute Bytes. 65 Symbols Detected.
