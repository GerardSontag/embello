Maximal CPM 2.2 BIOS for eZ80 -jcw, 2017-03-17 Z80ASM 1.32 Page   1
MAXBIOS Z80

    2                   
    3                   ; memory map -------------------------------------------------------------------
    4                   
    5         E400      CCP     equ 0E400h
    6         EC06      BDOS    equ CCP + 0806h
    7         FA00      BIOS    equ CCP + 1600h
    8                   
    9         0020      BANK	equ 20h     ; SRAM and MBASE are set to this bank
   10         003A      FROM	equ 3Ah     ; bank from which to copy everything
   11         6000      FOFF	equ 6000h   ; starting page offset in FROM area
   12         0023      FROM2	equ 23h     ; second RAM disk page
   13         E000      FOFF2	equ 0E000h  ; second RAM disk offset
   14                   
   15                   ; low memory -------------------------------------------------------------------
   16                   
   17         0003      iobyte  equ 03h     ; Intel standard I/O definition byte
   18         0004      usrdrv  equ 04h     ; Current user number and drive
   19         0080      tpabuf  equ 0080h   ; Default I/O buffer and command line storage
   20                   
   21         FA00               org BIOS
   22                   
   23                   ; BIOS jump table --------------------------------------------------------------
   24                   
   25 FA00  C3 FAC0     	jp boot     ;  0 Initialize
   26 FA03  C3 FAE8     wboote: jp wboot    ;  1 Warm boot
   27 FA06  C3 FB22     	jp conist   ;  2 Console status
   28 FA09  C3 FB2A     	jp conin    ;  3 Console input
   29 FA0C  C3 FB33     	jp conout   ;  4 Console OUTput
   30 FA0F  C3 FB41     	jp list     ;  5 List OUTput
   31 FA12  C3 FB41     	jp punch    ;  6 punch OUTput
   32 FA15  C3 FB3E     	jp reader   ;  7 Reader input
   33 FA18  C3 FB5A     	jp home     ;  8 Home disk
   34 FA1B  C3 FB43     	jp seldsk   ;  9 Select disk
   35 FA1E  C3 FB5C     	jp settrk   ; 10 Select track
   36 FA21  C3 FB61     	jp setsec   ; 11 Select sector
   37 FA24  C3 FB66     	jp setdma   ; 12 Set DMA ADDress
   38 FA27  C3 FB6E     	jp read     ; 13 Read 128 bytes
   39 FA2A  C3 FB82     	jp write    ; 14 Write 128 bytes
   40 FA2D  C3 FB41     	jp listst   ; 15 List status
   41 FA30  C3 FB6B     	jp sectrn   ; 16 Sector translate
   42                   
   43                   ; Disk Parameter Headers -------------------------------------------------------
   44                   
   45 FA33  0000  0000  dpbase:	dw 0,0,0,0,dirbuf,dpb0,0,alv0     ; A: 256/360K RAM disk
   46 FA43  0000  0000  	dw 0,0,0,0,dirbuf,dpb1,0,alv1     ; B: 256K flash disk
   47 FA53  0000  0000   	dw 0,0,0,0,dirbuf,dpb2,0,alv2     ; C: optional 1440K RAM disk
   48 FA63  0000  0000  	dw 0,0,0,0,dirbuf,dpb2,csv3,alv3  ; D: remote disk
   49 FA73  0000  0000  	dw 0,0,0,0,dirbuf,dpb2,csv4,alv4  ; E: remote disk
   50 FA83  0000  0000  	dw 0,0,0,0,dirbuf,dpb2,csv2,alv5  ; F: remote disk
   51                   
   52 FA93  001A        dpb0:	dw 26  ; SPT - sectors per track
   53 FA95  03          	db 3   ; BSH - block shift factor
   54 FA96  07          	db 7   ; BLM - block mask
   55 FA97  00          	db 0   ; EXM - Extent mask
   56 FA98  00F8        	dw 248 ; DSM - Storage size (blocks - 1)
   57 FA9A  003F        	dw 63  ; DRM - Number of directory entries - 1
   58 FA9C  C0          	db 192 ; AL0 - 1 bit set per directory block
   59 FA9D  00          	db 0   ; AL1 - ... 8 more bits
Maximal CPM 2.2 BIOS for eZ80 -jcw, 2017-03-17 Z80ASM 1.32 Page   2
MAXBIOS Z80

   60 FA9E  0000        	dw 0   ; CKS - DIR check vector size (DRM+1)/4 (0=fixed disk)
   61 FAA0  0002        	dw 2   ; OFF - Reserved tracks
   62                   
   63 FAA2  001A        dpb1:	dw 26  ; SPT - sectors per track
   64 FAA4  03          	db 3   ; BSH - block shift factor
   65 FAA5  07          	db 7   ; BLM - block mask
   66 FAA6  00          	db 0   ; EXM - Extent mask
   67 FAA7  00F8        	dw 248 ; DSM - Storage size (blocks - 1)
   68 FAA9  003F        	dw 63  ; DRM - Number of directory entries - 1
   69 FAAB  C0          	db 192 ; AL0 - 1 bit set per directory block
   70 FAAC  00          	db 0   ; AL1 - ... 8 more bits
   71 FAAD  0000        	dw 0   ; CKS - DIR check vector size (DRM+1)/4 (0=fixed disk)
   72 FAAF  0002        	dw 2   ; OFF - Reserved tracks
   73                   
   74 FAB1  0048        dpb2:	dw 72  ; SPT - sectors per track
   75 FAB3  04          	db 4   ; BSH - block shift factor
   76 FAB4  0F          	db 15  ; BLM - block mask
   77 FAB5  00          	db 0   ; EXM - Extent mask
   78 FAB6  02C6        	dw 710 ; DSM - Storage size (blocks - 1)
   79 FAB8  00FF        	dw 255 ; DRM - Number of directory entries - 1
   80 FABA  F0          	db 240 ; AL0 - 1 bit set per directory block
   81 FABB  00          	db 0   ; AL1 - ... 8 more bits
   82 FABC  0040        	dw 64  ; CKS - DIR check vector size (DRM+1)/4 (0=fixed disk)
   83 FABE  0002        	dw 2   ; OFF - Reserved tracks
   84                   
   85                   ; Cold boot --------------------------------------------------------------------
   86                   
   87 FAC0  F3          boot:	di
   88 FAC1  31 0100     	ld sp,0100h
   89 FAC4  21 FA00     	ld hl,BIOS
   90 FAC7  22 FFFE     	ld (0FFFEh),hl
   91                   
   92                   	; initialise UART0 to 9600 baud
   93                   
   94 FACA  21 0380     	ld hl,0380h
   95 FACD  11 1A06     	ld de,1A06h
   96 FAD0  ED 21 A5    	db 0EDh,21h,0A5h        ; out0 (0A5h),h = 03h
   97 FAD3  ED 29 C3    	db 0EDh,29h,0C3h        ; out0 (0C3h),l = 80h
   98 FAD6  ED 11 C0    	db 0EDh,11h,0C0h        ; out0 (0C0h),d = 1Ah
   99 FAD9  ED 21 C3    	db 0EDh,21h,0C3h        ; out0 (0C3h),h = 03h
  100 FADC  ED 19 C2    	db 0EDh,19h,0C2h        ; out0 (0C2h),e = 06h
  101                   
  102 FADF  AF          	xor a
  103 FAE0  32 0003     	ld (iobyte),a
  104 FAE3  32 0004     	ld (usrdrv),a
  105 FAE6  18 16       	jr gocpm
  106                   
  107                   ; Warm boot --------------------------------------------------------------------
  108                   
  109 FAE8  F3          wboot:	di
  110 FAE9  31 0100     	ld sp,0100h
  111                   
  112                   	; copy 5.5K from {FROM,FOFF+0100h} to {BANK,CCP} to reload CCP
  113                   
  114 FAEC  5B 21       	db 5Bh,21h              ; ld.lil hl,{FROM,FOFF+0100h}
  115 FAEE  6100        	dw FOFF+0100h
  116 FAF0  3A          	db FROM
  117 FAF1  5B 11       	db 5Bh,11h              ; ld.lil de,{BANK,CCP}
Maximal CPM 2.2 BIOS for eZ80 -jcw, 2017-03-17 Z80ASM 1.32 Page   3
MAXBIOS Z80

  118 FAF3  E400        	dw CCP
  119 FAF5  20          	db BANK
  120 FAF6  5B 01       	db 5Bh,01h              ; ld.lil bc,BIOS-CCP
  121 FAF8  1600        	dw BIOS-CCP
  122 FAFA  00          	db 0
  123 FAFB  49 ED B0    	db 49h,0EDh,0B0h        ; ldir.l
  124                   
  125                   ; Common code for cold and warm boot
  126                   
  127 FAFE  21 0080     gocpm:	ld hl,tpabuf            ; Address of BIOS DMA buffer
  128 FB01  22 FC62     	ld (dmaadr),hl
  129                   
  130 FB04  CD FC09     	call vinit		; set up SPI for virtual disks
  131                   
  132 FB07  3E C3       	ld a,0C3h               ; Opcode for 'JP'
  133 FB09  32 0000     	LD (00h),a              ; Load at start of RAM
  134 FB0C  21 FA03     	ld hl,wboote            ; Address of jump for a warm boot
  135 FB0F  22 0001     	ld (01h),hl
  136 FB12  32 0005     	ld (05h),a              ; Opcode for 'JP'
  137 FB15  21 EC06     	ld hl,BDOS              ; Address of jump for the BDOS
  138 FB18  22 0006     	ld (06h),hl
  139 FB1B  3A 0004     	ld a,(usrdrv)           ; Save new drive number (0)
  140 FB1E  4F          	ld c,a                  ; Pass drive number in C
  141 FB1F  C3 E400     	jp CCP                  ; Start CP/M by jumping to the CCP
  142                   
  143                   ; Console I/O ------------------------------------------------------------------
  144                   
  145 FB22  ED 38 C5    conist:	db 0EDh,38h,0C5h ; in0 a,(0C5h)
  146 FB25  E6 01       	and 01h
  147 FB27  ED 44       	neg
  148 FB29  C9          	ret
  149                   
  150 FB2A  CD FB22     conin:	call conist
  151 FB2D  28 FB       	jr z,conin
  152 FB2F  ED 38 C0    	db 0EDh,38h,0C0h        ; in0 a,(0C0h)
  153 FB32  C9          	ret
  154                   
  155 FB33  ED 38 C5    conout:	db 0EDh,38h,0C5h        ; in0 a,(0C5h)
  156 FB36  E6 20       	and 20h
  157 FB38  28 F9       	jr z,conout
  158 FB3A  ED 09 C0    	db 0EDh,09h,0C0h        ; out0 (0C0h),c
  159 FB3D  C9          	ret
  160                   
  161 FB3E  3E 1A       reader:	ld a,1Ah
  162 FB40  C9          	ret
  163                   
  164 FB41              listst:
  165 FB41              list:
  166 FB41              punch:
  167 FB41  AF          	xor a
  168 FB42  C9          	ret
  169                   
  170                   ; Disk I/O ---------------------------------------------------------------------
  171                   
  172 FB43  21 0000     seldsk: ld hl, 0
  173 FB46  79          	ld a,c
  174 FB47  FE 06       	cp 6
  175 FB49  D0                  ret nc
Maximal CPM 2.2 BIOS for eZ80 -jcw, 2017-03-17 Z80ASM 1.32 Page   4
MAXBIOS Z80

  176 FB4A  6F                  ld l,a
  177 FB4B  29          	add hl,hl
  178 FB4C  29          	add hl,hl
  179 FB4D  29          	add hl,hl
  180 FB4E  29          	add hl,hl
  181 FB4F  11 FA33             ld de,dpbase
  182 FB52  19                  add hl,de
  183 FB53  32 FC68     	ld (sekdsk),a
  184 FB56  22 FC69             ld (sekdpt),hl
  185 FB59  C9                  ret
  186                   
  187 FB5A  0E 00       home:	ld c,0
  188 FB5C  79          settrk: ld a,c
  189 FB5D  32 FC6B     	ld (sektrk),a
  190 FB60  C9                  ret
  191                   
  192 FB61  ED 43 FC6C  setsec: ld (seksec),bc
  193 FB65  C9                  ret
  194                   
  195 FB66  ED 43 FC62  setdma: ld (dmaadr),bc
  196 FB6A  C9                  ret
  197                   
  198 FB6B  69          sectrn: ld l,c
  199 FB6C  60          	ld h,b
  200 FB6D  C9                  ret
  201                   
  202 FB6E  CD FC2D     read:	call rwaddr
  203                   
  204 FB71  FE 03               cp 3
  205 FB73  30 33               jr nc,vread		; D/E/F: are virtual
  206                   
  207 FB75  5B 2A       	db 5Bh,2Ah              ; ld.lil hl,({BANK,dskadr})
  208 FB77  FC65        	dw dskadr
  209 FB79  20          	db BANK
  210 FB7A  5B ED 5B    	db 5Bh,0EDh,5Bh         ; ld.lil de,({BANK,dmaadr})
  211 FB7D  FC62        	dw dmaadr
  212 FB7F  20          	db BANK
  213                   
  214 FB80  18 15       	jr rwop
  215                   
  216 FB82  CD FC2D     write:	call rwaddr
  217                   
  218 FB85  B7                  or a			; A: is writable
  219 FB86  28 04               jr z,wram
  220 FB88  FE 02               cp 2			; C: is also writable
  221 FB8A  20 15               jr nz,wother
  222                   
  223 FB8C  5B 2A       wram:	db 5Bh,2Ah              ; ld.lil hl,({BANK,dmaadr})
  224 FB8E  FC62        	dw dmaadr
  225 FB90  20          	db BANK
  226 FB91  5B ED 5B    	db 5Bh,0EDh,5Bh         ; ld.lil de,({BANK,dskadr})
  227 FB94  FC65        	dw dskadr
  228 FB96  20          	db BANK
  229                   
  230 FB97  5B 01 80 00 rwop:	db 5Bh,01h,80h,00h,00h  ; ld.lil bc,000080h
  231 FB9C  49 ED B0    	db 49h,0EDh,0B0h        ; ldir.l
  232 FB9F  AF          	xor a
  233 FBA0  C9          	ret
Maximal CPM 2.2 BIOS for eZ80 -jcw, 2017-03-17 Z80ASM 1.32 Page   5
MAXBIOS Z80

  234                   
  235 FBA1  FE 03       wother:	cp 3			; D: is virtual and writable
  236 FBA3  28 1B               jr z,vwrite
  237 FBA5  3E 02       	ld a,2			; disk is read-only
  238 FBA7  C9          	ret
  239                   
  240         009A      PB_DR	equ 9Ah
  241         009B      PB_DDR	equ 9Bh
  242         009C      PB_ALT1	equ 9Ch
  243         009D      PB_ALT2	equ 9Dh
  244                   
  245         00B8      SPI_BRGL equ 0B8h
  246         00B9      SPI_BRGH equ 0B9h
  247         00BA      SPI_CTL  equ 0BAh
  248         00BB      SPI_SR   equ 0BBh
  249         00BC      SPI_TSR  equ 0BCh
  250         00BC      SPI_RBR  equ 0BCh
  251                   
  252                   ; Virtual disk read, disk# in A
  253                   
  254 FBA8  CD FBD3     vread:  call vrwop		; 0..3: request
  255 FBAB  CD FBEB             call vidle		; wait until idle
  256 FBAE  AF          	xor a
  257 FBAF  CD FBFD     vread1:	call vxfer		; 0..127: read data
  258 FBB2  77          	ld (hl),a
  259 FBB3  23          	inc hl
  260 FBB4  10 F9       	djnz vread1
  261 FBB6  AF          vdone:	xor a
  262 FBB7  ED 08 9A    vstop:	db 0EDh,08h,PB_DR	; in0 c,(PB_DR)
  263 FBBA  CB C1       	set 0,c			; set NSS high (PB0)
  264 FBBC  ED 09 9A    	db 0EDh,09h,PB_DR	; out0 (PB_DR),c
  265 FBBF  C9                  ret
  266                   
  267                   ; Virtual disk write, disk# in A
  268                   
  269 FBC0  F6 08       vwrite:	or 8			; tag as write request
  270 FBC2  CD FBD3     	call vrwop		; 0..3: request
  271 FBC5  CD FBFB     vwrit1:	call vnext		; 4..131: write data
  272 FBC8  10 FB       	djnz vwrit1
  273 FBCA  CD FBEB             call vidle		; wait until idle
  274 FBCD  AF          	xor a
  275 FBCE  CD FBFD     	call vxfer		; get write status
  276 FBD1  18 E3       	jr vdone		; TODO should be vstop
  277                   
  278                   ; Common virtual read/write code to send 4-byte request header
  279                   ; Expects request code in A
  280                   ; Returns DMA address in HL, 128 in B
  281                   
  282 FBD3  CD FBEB     vrwop:	call vidle		; wait until idle
  283 FBD6  CD FBFD             call vxfer		; 0: write request (seldsk+8)
  284 FBD9  21 FC65             ld hl,dskadr
  285 FBDC  CD FBFB             call vnext		; 1: offset, bits 7..0
  286 FBDF  CD FBFB             call vnext		; 2: offset, bits 15..8
  287 FBE2  CD FBFB             call vnext		; 3: offset, bits 23..16
  288 FBE5  2A FC62     	ld hl,(dmaadr)
  289 FBE8  06 80       	ld b,128
  290 FBEA  C9          	ret
  291                   
Maximal CPM 2.2 BIOS for eZ80 -jcw, 2017-03-17 Z80ASM 1.32 Page   6
MAXBIOS Z80

  292 FBEB  CD FBB7     vidle:	call vstop
  293 FBEE  ED 08 9A    vidle1:	db 0EDh,08h,PB_DR	; in0 c,(PB_DR)
  294 FBF1  CB 49       	bit 1,c			; test BUSY (PB1)
  295 FBF3  20 F9       	jr nz,vidle1		; reply is not zero, repeat
  296 FBF5  CB 81       	res 0,c			; set NSS low (PB0)
  297 FBF7  ED 09 9A    	db 0EDh,09h,PB_DR	; out0 (PB_DR),c
  298 FBFA  C9          	ret
  299                   
  300 FBFB  7E          vnext:	ld a,(hl)
  301 FBFC  23          	inc hl
  302 FBFD  ED 39 BC    vxfer:	db 0EDh,39h,SPI_TSR	; out0 (SPI_TSR),a
  303 FC00  ED 38 BB    vxfer1:	db 0EDh,38h,SPI_SR	; in0 a,(SPI_SR)
  304 FC03  28 FB       	jr z,vxfer1
  305 FC05  ED 38 BC    	db 0EDh,38h,SPI_RBR	; in0 a,(SPI_RBR)
  306 FC08  C9                  ret
  307                   
  308 FC09  3E 89       vinit:	ld a,89h
  309 FC0B  ED 39 9A    	db 0EDh,39h,PB_DR	; out0 (PB_DR),a
  310 FC0E  3E CE       	ld a,0CEh
  311 FC10  ED 39 9B    	db 0EDh,39h,PB_DDR	; out0 (PB_DDR),a
  312 FC13  3E 00       	ld a,00h
  313 FC15  ED 39 9C    	db 0EDh,39h,PB_ALT1	; out0 (PB_ALT1),a
  314 FC18  3E CC       	ld a,0CCh
  315 FC1A  ED 39 9D    	db 0EDh,39h,PB_ALT2	; out0 (PB_ALT2),a
  316 FC1D  3E 00       	ld a,00H
  317 FC1F  ED 39 B9    	db 0EDh,39h,SPI_BRGH	; out0 (SPI_BRG_H),a
  318 FC22  3E 03       	ld a,03h
  319 FC24  ED 39 B8    	db 0EDh,39h,SPI_BRGL	; out0 (SPI_BRG_L),a
  320 FC27  3E 30       	ld a,30h
  321 FC29  ED 39 BA    	db 0EDh,39h,SPI_CTL	; out0 (SPI_CTL),a
  322 FC2C  C9          	ret
  323                   
  324                   ; Convert selected disk+track+sector to a memory address
  325                   ; Returns current disk in A, 24-bit address in dskadr[0..2], upper 16-bit in HL
  326                   
  327 FC2D  2A FC69     rwaddr:	ld hl,(sekdpt)
  328 FC30  01 000A             ld bc,10
  329 FC33  09                  add hl,bc
  330 FC34  ED 27               db 0EDh,27h             ; ld hl,(hl) ; dpb
  331 FC36  7E                  ld a,(hl)               ; spt
  332 FC37  ED 4B FC6B          ld bc,(sektrk)
  333 FC3B  47          	ld b,a
  334 FC3C  ED 4C       	db 0EDh,4Ch             ; mlt bc
  335                   	; BC = track, converted to linear sector offset
  336 FC3E  2A FC6C     	ld hl,(seksec)
  337 FC41  09          	add hl,bc
  338                   	; HL = bits 30..23 of the requested disk block address
  339 FC42  AF          	xor a
  340 FC43  CB 1C       	rr h
  341 FC45  CB 1D       	rr l
  342 FC47  1F          	rra
  343                   	; A = bits 7..0 of the 24-bit disk-block address
  344 FC48  32 FC65     	ld (dskadr),a
  345                   	; add the disk base to bits 23..16, if drive A: or C:
  346 FC4B  3A FC68             ld a,(sekdsk)
  347 FC4E  B7                  or a
  348 FC4F  20 05               jr nz,rwadr1
  349 FC51  01 3A60     	ld bc,FROM*256+(FOFF/256)   ; A: is RAM disk at (FROM,FOFF)
Maximal CPM 2.2 BIOS for eZ80 -jcw, 2017-03-17 Z80ASM 1.32 Page   7
MAXBIOS Z80

  350 FC54  18 07       	jr rwadr2
  351 FC56  FE 02       rwadr1: cp 2			    ; B/D/E/F: do not have an offset
  352 FC58  20 04       	jr nz,rwadr3
  353 FC5A  01 23E0     	ld bc,FROM2*256+(FOFF2/256) ; C: is RAM disk at (FROM2,FOFF2)
  354 FC5D  09          rwadr2:	add hl,bc
  355 FC5E              rwadr3: ; HL = bits 23..8 of the 24-bit disk-block address
  356 FC5E  22 FC66     	ld (dskadr+1),hl
  357 FC61  C9          	ret
  358                   
  359                   ; Data area --------------------------------------------------------------------
  360                   
  361 FC62  80 00 20    dmaadr: db 80h,00h,BANK ; last dma address + bank
  362                   
  363                   ; End of initialised data
  364                   
  365 FC65    0003      dskadr: ds 3   ; disk address + bank
  366                   
  367 FC68    0001      sekdsk: ds 1   ; seek disk number
  368 FC69    0002      sekdpt: ds 2   ; seek disk parameter table
  369 FC6B    0001      sektrk: ds 1   ; seek track number
  370 FC6C    0002      seksec: ds 2   ; seek sector number
  371                   
  372 FC6E    0080      dirbuf: ds 128 ; scratch directory area
  373                   
  374 FCEE    002E      alv0:   ds 46  ; allocation vector 0 (max 360 blocks)
  375 FD1C    0020      alv1:   ds 32  ; allocation vector 1 (max 255 blocks)
  376 FD3C    005B      alv2:   ds 91  ; allocation vector 2 (max 720 blocks)
  377 FD97    005B      alv3:   ds 91  ; allocation vector 3 (max 720 blocks)
  378 FDF2    005B      alv4:   ds 91  ; allocation vector 4 (max 720 blocks)
  379 FE4D    005B      alv5:   ds 91  ; allocation vector 5 (max 720 blocks)
  380                   
  381 FEA8    0040      csv2:   ds 64  ; checksum vector 2 (max 256 dir entries)
  382 FEE8    0040      csv3:   ds 64  ; checksum vector 3 (max 256 dir entries)
  383 FF28    0040      csv4:   ds 64  ; checksum vector 4 (max 256 dir entries)
  384                   
  385         FF68      biosEnd equ $ ; ----------------------------------------------------------------
  386                   
  387                           end
 0 Error(s) Detected.
 1384 Absolute Bytes. 81 Symbols Detected.
