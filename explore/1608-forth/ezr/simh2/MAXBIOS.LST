Minimal CPM 2.2 BIOS for eZ80 -jcw, 2017-03-17 Z80ASM 1.32 Page   1
MAXBIOS Z80

    2                   
    3                   ; memory map -------------------------------------------------------------------
    4                   
    5         E700      CCP     equ 0E700h
    6         EF06      BDOS    equ CCP + 0806h
    7         FD00      BIOS    equ CCP + 1600h
    8                   
    9         0020      BANK	equ 20h     ; SRAM and MBASE are set to this bank
   10         003A      FROM	equ 3Ah     ; bank from which to copy everything
   11         6000      FOFF	equ 6000h   ; starting page offset in FROM area
   12                   
   13                   ; low memory -------------------------------------------------------------------
   14                   
   15         0003      iobyte  equ 03h     ; Intel standard I/O definition byte
   16         0004      usrdrv  equ 04h     ; Current user number and drive
   17         0080      tpabuf  equ 0080h   ; Default I/O buffer and command line storage
   18                   
   19         FD00               org BIOS
   20                   
   21                   ; BIOS jump table --------------------------------------------------------------
   22                   
   23 FD00  C3 FD91     	jp boot     ;  0 Initialize
   24 FD03  C3 FDB9     wboote: jp wboot    ;  1 Warm boot
   25 FD06  C3 FDF3     	jp conist   ;  2 Console status
   26 FD09  C3 FDFB     	jp conin    ;  3 Console input
   27 FD0C  C3 FE04     	jp conout   ;  4 Console OUTput
   28 FD0F  C3 FE71     	jp list     ;  5 List OUTput
   29 FD12  C3 FE71     	jp punch    ;  6 punch OUTput
   30 FD15  C3 FE0F     	jp reader   ;  7 Reader input
   31 FD18  C3 FE30     	jp home     ;  8 Home disk
   32 FD1B  C3 FE12     	jp seldsk   ;  9 Select disk
   33 FD1E  C3 FE32     	jp settrk   ; 10 Select track
   34 FD21  C3 FE37     	jp setsec   ; 11 Select sector
   35 FD24  C3 FE3C     	jp setdma   ; 12 Set DMA ADDress
   36 FD27  C3 FE44     	jp read     ; 13 Read 128 bytes
   37 FD2A  C3 FE58     	jp write    ; 14 Write 128 bytes
   38 FD2D  C3 FE71     	jp listst   ; 15 List status
   39 FD30  C3 FE41     	jp sectrn   ; 16 Sector translate
   40                   
   41                   ; Disk Parameter Headers -------------------------------------------------------
   42                   
   43 FD33  0000  0000  dpbase:	dw 0,0,0,0,dirbuf,dpb0,0,alv0   ; A: is RAM disk @ 36h
   44 FD43  0000  0000  	dw 0,0,0,0,dirbuf,dpb1,0,alv1   ; B: is flash @ 00h
   45 FD53  0000  0000  	dw 0,0,0,0,dirbuf,dpb1,0,alv1   ; C: is for future use
   46 FD63  0000  0000  	dw 0,0,0,0,dirbuf,dpb1,0,alv2   ; D: is remote disk
   47                   
   48 FD73  001A        dpb0:	dw 26  ; SPT - sectors per track
   49 FD75  03          	db 3   ; BSH - block shift factor
   50 FD76  07          	db 7   ; BLM - block mask
   51 FD77  00          	db 0   ; EXM - Extent mask
   52 FD78  00F8        	dw 248 ; DSM - Storage size (blocks - 1)
   53 FD7A  003F        	dw 63  ; DRM - Number of directory entries - 1
   54 FD7C  C0          	db 192 ; AL0 - 1 bit set per directory block
   55 FD7D  00          	db 0   ; AL1 - ... 8 more bits
   56 FD7E  0000        	dw 0   ; CKS - DIR check vector size (DRM+1)/4 (0=fixed disk)
   57 FD80  0002        	dw 2   ; OFF - Reserved tracks
   58                   
   59 FD82  001A        dpb1:	dw 26  ; SPT - sectors per track
Minimal CPM 2.2 BIOS for eZ80 -jcw, 2017-03-17 Z80ASM 1.32 Page   2
MAXBIOS Z80

   60 FD84  03          	db 3   ; BSH - block shift factor
   61 FD85  07          	db 7   ; BLM - block mask
   62 FD86  00          	db 0   ; EXM - Extent mask
   63 FD87  00F8        	dw 248 ; DSM - Storage size (blocks - 1)
   64 FD89  003F        	dw 63  ; DRM - Number of directory entries - 1
   65 FD8B  C0          	db 192 ; AL0 - 1 bit set per directory block
   66 FD8C  00          	db 0   ; AL1 - ... 8 more bits
   67 FD8D  0000        	dw 0   ; CKS - DIR check vector size (DRM+1)/4 (0=fixed disk)
   68 FD8F  0002        	dw 2   ; OFF - Reserved tracks
   69                   
   70                   ; Cold boot --------------------------------------------------------------------
   71                   
   72 FD91  F3          boot:	di
   73 FD92  31 0100     	ld sp,0100h
   74 FD95  21 FD00     	ld hl,BIOS
   75 FD98  22 FFFE     	ld (0FFFEh),hl
   76                   
   77                   	; initialise UART0 to 9600 baud
   78                   
   79 FD9B  21 0380     	ld hl,0380h
   80 FD9E  11 1A06     	ld de,1A06h
   81 FDA1  ED 21 A5    	db 0EDh,21h,0A5h        ; out0 (0A5h),h = 03h
   82 FDA4  ED 29 C3    	db 0EDh,29h,0C3h        ; out0 (0C3h),l = 80h
   83 FDA7  ED 11 C0    	db 0EDh,11h,0C0h        ; out0 (0C0h),d = 1Ah
   84 FDAA  ED 21 C3    	db 0EDh,21h,0C3h        ; out0 (0C3h),h = 03h
   85 FDAD  ED 19 C2    	db 0EDh,19h,0C2h        ; out0 (0C2h),e = 06h
   86                   
   87 FDB0  AF          	xor a
   88 FDB1  32 0003     	ld (iobyte),a
   89 FDB4  32 0004     	ld (usrdrv),a
   90 FDB7  18 16       	jr gocpm
   91                   
   92                   ; Warm boot --------------------------------------------------------------------
   93                   
   94 FDB9  F3          wboot:	di
   95 FDBA  31 0100     	ld sp,0100h
   96                   
   97                   	; copy 5.5K from {FROM,FOFF+0100h} to {BANK,CCP} to reload CCP
   98                   
   99 FDBD  5B 21       	db 5Bh,21h              ; ld.lil hl,{FROM,FOFF+0100h}
  100 FDBF  6100        	dw FOFF+0100h
  101 FDC1  3A          	db FROM
  102 FDC2  5B 11       	db 5Bh,11h              ; ld.lil de,{BANK,CCP}
  103 FDC4  E700        	dw CCP
  104 FDC6  20          	db BANK
  105 FDC7  5B 01       	db 5Bh,01h              ; ld.lil bc,BIOS-CCP
  106 FDC9  1600        	dw BIOS-CCP
  107 FDCB  00          	db 0
  108 FDCC  49 ED B0    	db 49h,0EDh,0B0h        ; ldir.l
  109                   
  110                   ; Common code for cold and warm boot
  111                   
  112 FDCF  21 0080     gocpm:	ld hl,tpabuf            ; Address of BIOS DMA buffer
  113 FDD2  22 FF07     	ld (dmaadr),hl
  114                   
  115 FDD5  CD FEBF     	call finit
  116                   
  117 FDD8  3E C3       	ld a,0C3h               ; Opcode for 'JP'
Minimal CPM 2.2 BIOS for eZ80 -jcw, 2017-03-17 Z80ASM 1.32 Page   3
MAXBIOS Z80

  118 FDDA  32 0000     	LD (00h),a              ; Load at start of RAM
  119 FDDD  21 FD03     	ld hl,wboote            ; Address of jump for a warm boot
  120 FDE0  22 0001     	ld (01h),hl
  121 FDE3  32 0005     	ld (05h),a              ; Opcode for 'JP'
  122 FDE6  21 EF06     	ld hl,BDOS              ; Address of jump for the BDOS
  123 FDE9  22 0006     	ld (06h),hl
  124 FDEC  3A 0004     	ld a,(usrdrv)           ; Save new drive number (0)
  125 FDEF  4F          	ld c,a                  ; Pass drive number in C
  126 FDF0  C3 E700     	jp CCP                  ; Start CP/M by jumping to the CCP
  127                   
  128                   ; Console I/O ------------------------------------------------------------------
  129                   
  130 FDF3  ED 38 C5    conist:	db 0EDh,38h,0C5h ; in0 a,(0C5h)
  131 FDF6  E6 01       	and 01h
  132 FDF8  ED 44       	neg
  133 FDFA  C9          	ret
  134                   
  135 FDFB  CD FDF3     conin:	call conist
  136 FDFE  28 FB       	jr z,conin
  137 FE00  ED 38 C0    	db 0EDh,38h,0C0h        ; in0 a,(0C0h)
  138 FE03  C9          	ret
  139                   
  140 FE04  ED 38 C5    conout:	db 0EDh,38h,0C5h        ; in0 a,(0C5h)
  141 FE07  E6 20       	and 20h
  142 FE09  28 F9       	jr z,conout
  143 FE0B  ED 09 C0    	db 0EDh,09h,0C0h        ; out0 (0C0h),c
  144 FE0E  C9          	ret
  145                   
  146 FE0F  3E 1A       reader:	ld a,1Ah
  147 FE11  C9          	ret
  148                   
  149                   ; Disk I/O ---------------------------------------------------------------------
  150                   
  151 FE12  79          seldsk: ld a,c
  152 FE13  FE 04       	cp 4
  153 FE15  30 0C               jr nc,baddsk
  154 FE17  06 10               ld b,16
  155 FE19  ED 4C       	db 0EDh,4Ch ; mlt bc
  156 FE1B  21 FD33             ld hl,dpbase
  157 FE1E  09                  add hl,bc
  158 FE1F  32 FF0D     savdsk:	ld (sekdsk),a
  159 FE22  C9                  ret
  160                   
  161 FE23  21 0000     baddsk: ld hl,0
  162 FE26  3A 0004             ld a,(usrdrv)
  163 FE29  91                  sub a,c
  164 FE2A  C0                  ret nz
  165 FE2B  32 0004             ld (usrdrv),a
  166 FE2E  18 EF               jr savdsk
  167                   
  168 FE30  0E 00       home:	ld c,0
  169 FE32  79          settrk: ld a,c
  170 FE33  32 FF0E     	ld (sektrk),a
  171 FE36  C9                  ret
  172                   
  173 FE37  ED 43 FF0F  setsec: ld (seksec),bc
  174 FE3B  C9                  ret
  175                   
Minimal CPM 2.2 BIOS for eZ80 -jcw, 2017-03-17 Z80ASM 1.32 Page   4
MAXBIOS Z80

  176 FE3C  ED 43 FF07  setdma: ld (dmaadr),bc
  177 FE40  C9                  ret
  178                   
  179 FE41  69          sectrn: ld l,c
  180 FE42  60          	ld h,b
  181 FE43  C9                  ret
  182                   
  183 FE44  CD FEE3     read:	call rwaddr
  184                   
  185 FE47  FE 03               cp 3
  186 FE49  28 2B               jr z,fread
  187                   
  188 FE4B  5B 2A       	db 5Bh,2Ah              ; ld.lil hl,({BANK,dskadr})
  189 FE4D  FF0A        	dw dskadr
  190 FE4F  20          	db BANK
  191 FE50  5B ED 5B    	db 5Bh,0EDh,5Bh         ; ld.lil de,({BANK,dmaadr})
  192 FE53  FF07        	dw dmaadr
  193 FE55  20          	db BANK
  194                   
  195 FE56  18 11       	jr rwop
  196                   
  197 FE58  CD FEE3     write:	call rwaddr
  198                   
  199 FE5B  B7                  or a			; only A: is writable
  200 FE5C  20 15               jr nz,wfail
  201                   
  202 FE5E  5B 2A       	db 5Bh,2Ah              ; ld.lil hl,({BANK,dmaadr})
  203 FE60  FF07        	dw dmaadr
  204 FE62  20          	db BANK
  205 FE63  5B ED 5B    	db 5Bh,0EDh,5Bh         ; ld.lil de,({BANK,dskadr})
  206 FE66  FF0A        	dw dskadr
  207 FE68  20          	db BANK
  208                   
  209 FE69  5B 01 80 00 rwop:	db 5Bh,01h,80h,00h,00h  ; ld.lil bc,000080h
  210 FE6E  49 ED B0    	db 49h,0EDh,0B0h        ; ldir.l
  211                   
  212 FE71              listst:
  213 FE71              list:
  214 FE71              punch:
  215 FE71  AF          	xor a
  216 FE72  C9          	ret
  217                   
  218 FE73  3E FF       wfail:	ld a,0FFh
  219 FE75  C9          	ret
  220                   
  221         009A      PB_DR	equ 9Ah
  222         009B      PB_DDR	equ 9Bh
  223         009C      PB_ALT1	equ 9Ch
  224         009D      PB_ALT2	equ 9Dh
  225                   
  226         00B8      SPI_BRGL equ 0B8h
  227         00B9      SPI_BRGH equ 0B9h
  228         00BA      SPI_CTL  equ 0BAh
  229         00BB      SPI_SR   equ 0BBh
  230         00BC      SPI_TSR  equ 0BCh
  231         00BC      SPI_RBR  equ 0BCh
  232                   
  233 FE76  CD FEA3     fread:  call fidle		; wait until idle
Minimal CPM 2.2 BIOS for eZ80 -jcw, 2017-03-17 Z80ASM 1.32 Page   5
MAXBIOS Z80

  234 FE79  CD FEB3             call fxfer		; 0 = read request (seldsk)
  235 FE7C  3A FF0A             ld a,(dskadr)		; 1 = offset, bits 7..0
  236 FE7F  CD FEB3             call fxfer
  237 FE82  7D                  ld a,l
  238 FE83  CD FEB3             call fxfer		; 2 = offset, bits 15..8
  239 FE86  7C                  ld a,h
  240 FE87  CD FEB3             call fxfer		; 3 = offset, bits 23..16
  241 FE8A  CD FEA3             call fidle		; wait until idle
  242 FE8D  2A FF07     	ld hl,(dmaadr)
  243 FE90  06 80       	ld b,128
  244 FE92  CD FEB3     fread1:	call fxfer		; 1..128 = read data
  245 FE95  77          	ld (hl),a
  246 FE96  23          	inc hl
  247 FE97  10 F9       	djnz fread1
  248 FE99  AF          	xor a
  249 FE9A  ED 08 9A    fstop:	db 0EDh,08h,PB_DR	; in0 c,(PB_DR)
  250 FE9D  CB C1       	set 0,c			; set NSS high (PB0)
  251 FE9F  ED 09 9A    	db 0EDh,09h,PB_DR	; out0 (PB_DR),c
  252 FEA2  C9                  ret
  253                   
  254 FEA3  CD FE9A     fidle:	call fstop
  255                   	; TODO may need a delay here...
  256 FEA6  ED 08 9A    fidle1:	db 0EDh,08h,PB_DR	; in0 c,(PB_DR)
  257 FEA9  CB 49       	bit 1,c			; test BUSY (PB1)
  258 FEAB  20 F9       	jr nz,fidle1		; reply is not zero, repeat
  259 FEAD  CB 81       	res 0,c			; set NSS low (PB0)
  260 FEAF  ED 09 9A    	db 0EDh,09h,PB_DR	; out0 (PB_DR),c
  261 FEB2  C9          	ret
  262                   
  263 FEB3  ED 39 BC    fxfer:	db 0EDh,39h,SPI_TSR	; out0 (SPI_TSR),a
  264 FEB6  ED 38 BB    fxfer1:	db 0EDh,38h,SPI_SR	; in0 a,(SPI_SR)
  265 FEB9  28 FB       	jr z,fxfer1
  266 FEBB  ED 38 BC    	db 0EDh,38h,SPI_RBR	; in0 a,(SPI_RBR)
  267 FEBE  C9                  ret
  268                   
  269 FEBF  3E 89       finit:	ld a,89h
  270 FEC1  ED 39 9A    	db 0EDh,39h,PB_DR	; out0 (PB_DR),a
  271 FEC4  3E CE       	ld a,0CEh
  272 FEC6  ED 39 9B    	db 0EDh,39h,PB_DDR	; out0 (PB_DDR),a
  273 FEC9  3E 00       	ld a,00h
  274 FECB  ED 39 9C    	db 0EDh,39h,PB_ALT1	; out0 (PB_ALT1),a
  275 FECE  3E CC       	ld a,0CCh
  276 FED0  ED 39 9D    	db 0EDh,39h,PB_ALT2	; out0 (PB_ALT2),a
  277 FED3  3E 00       	ld a,00H
  278 FED5  ED 39 B9    	db 0EDh,39h,SPI_BRGH	; out0 (SPI_BRG_H),a
  279 FED8  3E 03       	ld a,03h
  280 FEDA  ED 39 B8    	db 0EDh,39h,SPI_BRGL	; out0 (SPI_BRG_L),a
  281 FEDD  3E 34       	ld a,34h
  282 FEDF  ED 39 BA    	db 0EDh,39h,SPI_CTL	; out0 (SPI_CTL),a
  283 FEE2  C9          	ret
  284                   
  285                   ; Convert selected disk+track+sector to a memory address
  286                   
  287 FEE3  ED 4B FF0E  rwaddr:	ld bc,(sektrk)
  288 FEE7  06 1A       	ld b,26
  289 FEE9  ED 4C       	db 0EDh,4Ch ; mlt bc
  290                   	; BC = track, converted to linear sector offset
  291 FEEB  2A FF0F     	ld hl,(seksec)
Minimal CPM 2.2 BIOS for eZ80 -jcw, 2017-03-17 Z80ASM 1.32 Page   6
MAXBIOS Z80

  292 FEEE  09          	add hl,bc
  293                   	; HL = bits 30..23 of the requested disk block address
  294 FEEF  AF          	xor a
  295 FEF0  CB 1C       	rr h
  296 FEF2  CB 1D       	rr l
  297 FEF4  CB 1F       	rr a
  298                   	; A = bits 7..0 of the 24-bit disk-block address
  299 FEF6  32 FF0A     	ld (dskadr),a
  300                   	; add the disk base to bits 23..16, if drive A:
  301 FEF9  3A FF0D             ld a,(sekdsk)
  302 FEFC  B7                  or a
  303 FEFD  20 04               jr nz,rwflsh
  304 FEFF  01 3A60     	ld bc,FROM*256+(FOFF/256)
  305 FF02  09          	add hl,bc
  306 FF03              rwflsh: ; HL = bits 23..8 of the 24-bit disk-block address
  307 FF03  22 FF0B     	ld (dskadr+1),hl
  308 FF06  C9          	ret
  309                   
  310                   ; Data area --------------------------------------------------------------------
  311                   
  312 FF07  80 00 20    dmaadr: db 80h,00h,BANK ; last dma address + bank
  313                   
  314                   ; End of initialised data
  315                   
  316 FF0A    0003      dskadr: ds 3   ; disk address + bank
  317                   
  318 FF0D    0001      sekdsk: ds 1   ; seek disk number
  319 FF0E    0001      sektrk: ds 1   ; seek track number
  320 FF0F    0002      seksec: ds 2   ; seek sector number
  321                   
  322 FF11    0080      dirbuf: ds 128 ; scratch directory area
  323 FF91    0020      alv0:   ds 32  ; allocation vector 0 (max 255 blocks)
  324 FFB1    0020      alv1:   ds 32  ; allocation vector 1 (max 255 blocks)
  325 FFD1    0020      alv2:   ds 32  ; allocation vector 1 (max 255 blocks)
  326                   
  327         FFF1      biosEnd equ $ ; ----------------------------------------------------------------
  328                   
  329                           end
 0 Error(s) Detected.
 753 Absolute Bytes. 65 Symbols Detected.
