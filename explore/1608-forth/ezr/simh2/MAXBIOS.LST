Maximal CPM 2.2 BIOS for eZ80 -jcw, 2017-03-17 Z80ASM 1.32 Page   1
MAXBIOS Z80

    2                   
    3                   ; memory map -------------------------------------------------------------------
    4                   
    5         E400      CCP     equ 0E400h
    6         EC06      BDOS    equ CCP + 0806h
    7         FA00      BIOS    equ CCP + 1600h
    8                   
    9         0020      BANK	equ 20h     ; SRAM and MBASE are set to this bank
   10         003A      FROM	equ 3Ah     ; bank from which to copy everything
   11         6000      FOFF	equ 6000h   ; starting page offset in FROM area
   12         0023      FROM2	equ 23h     ; second RAM disk page
   13         E000      FOFF2	equ 0E000h  ; second RAM disk offset
   14                   
   15                   ; low memory -------------------------------------------------------------------
   16                   
   17         0003      iobyte  equ 03h     ; Intel standard I/O definition byte
   18         0004      usrdrv  equ 04h     ; Current user number and drive
   19         0080      tpabuf  equ 0080h   ; Default I/O buffer and command line storage
   20                   
   21         FA00               org BIOS
   22                   
   23                   ; BIOS jump table --------------------------------------------------------------
   24                   
   25 FA00  C3 FAC0     	jp boot     ;  0 Initialize
   26 FA03  C3 FAE8     wboote: jp wboot    ;  1 Warm boot
   27 FA06  C3 FB22     	jp conist   ;  2 Console status
   28 FA09  C3 FB2A     	jp conin    ;  3 Console input
   29 FA0C  C3 FB33     	jp conout   ;  4 Console OUTput
   30 FA0F  C3 FB41     	jp list     ;  5 List OUTput
   31 FA12  C3 FB41     	jp punch    ;  6 punch OUTput
   32 FA15  C3 FB3E     	jp reader   ;  7 Reader input
   33 FA18  C3 FB64     	jp home     ;  8 Home disk
   34 FA1B  C3 FB43     	jp seldsk   ;  9 Select disk
   35 FA1E  C3 FB66     	jp settrk   ; 10 Select track
   36 FA21  C3 FB6B     	jp setsec   ; 11 Select sector
   37 FA24  C3 FB70     	jp setdma   ; 12 Set DMA ADDress
   38 FA27  C3 FB78     	jp read     ; 13 Read 128 bytes
   39 FA2A  C3 FB8C     	jp write    ; 14 Write 128 bytes
   40 FA2D  C3 FB41     	jp listst   ; 15 List status
   41 FA30  C3 FB75     	jp sectrn   ; 16 Sector translate
   42                   
   43                   ; Disk Parameter Headers -------------------------------------------------------
   44                   
   45 FA33  0000  0000  dpbase:	dw 0,0,0,0,dirbuf,dpb0,0,alv0     ; A: 256/360K RAM disk
   46 FA43  0000  0000  	dw 0,0,0,0,dirbuf,dpb1,0,alv1     ; B: 256K flash disk
   47 FA53  0000  0000   	dw 0,0,0,0,dirbuf,dpb2,0,alv2     ; C: optional 1440K RAM disk
   48 FA63  0000  0000  	dw 0,0,0,0,dirbuf,dpb2,csv3,alv3  ; D: remote disk
   49 FA73  0000  0000  	dw 0,0,0,0,dirbuf,dpb2,csv4,alv4  ; E: remote disk
   50 FA83  0000  0000  	dw 0,0,0,0,dirbuf,dpb2,csv2,alv5  ; F: remote disk
   51                   
   52 FA93  001A        dpb0:	dw 26  ; SPT - sectors per track
   53 FA95  03          	db 3   ; BSH - block shift factor
   54 FA96  07          	db 7   ; BLM - block mask
   55 FA97  00          	db 0   ; EXM - Extent mask
   56 FA98  00F8        	dw 248 ; DSM - Storage size (blocks - 1)
   57 FA9A  003F        	dw 63  ; DRM - Number of directory entries - 1
   58 FA9C  C0          	db 192 ; AL0 - 1 bit set per directory block
   59 FA9D  00          	db 0   ; AL1 - ... 8 more bits
Maximal CPM 2.2 BIOS for eZ80 -jcw, 2017-03-17 Z80ASM 1.32 Page   2
MAXBIOS Z80

   60 FA9E  0000        	dw 0   ; CKS - DIR check vector size (DRM+1)/4 (0=fixed disk)
   61 FAA0  0002        	dw 2   ; OFF - Reserved tracks
   62                   
   63 FAA2  001A        dpb1:	dw 26  ; SPT - sectors per track
   64 FAA4  03          	db 3   ; BSH - block shift factor
   65 FAA5  07          	db 7   ; BLM - block mask
   66 FAA6  00          	db 0   ; EXM - Extent mask
   67 FAA7  00F8        	dw 248 ; DSM - Storage size (blocks - 1)
   68 FAA9  003F        	dw 63  ; DRM - Number of directory entries - 1
   69 FAAB  C0          	db 192 ; AL0 - 1 bit set per directory block
   70 FAAC  00          	db 0   ; AL1 - ... 8 more bits
   71 FAAD  0000        	dw 0   ; CKS - DIR check vector size (DRM+1)/4 (0=fixed disk)
   72 FAAF  0002        	dw 2   ; OFF - Reserved tracks
   73                   
   74 FAB1  0048        dpb2:	dw 72  ; SPT - sectors per track
   75 FAB3  04          	db 4   ; BSH - block shift factor
   76 FAB4  0F          	db 15  ; BLM - block mask
   77 FAB5  00          	db 0   ; EXM - Extent mask
   78 FAB6  02C6        	dw 710 ; DSM - Storage size (blocks - 1)
   79 FAB8  00FF        	dw 255 ; DRM - Number of directory entries - 1
   80 FABA  F0          	db 240 ; AL0 - 1 bit set per directory block
   81 FABB  00          	db 0   ; AL1 - ... 8 more bits
   82 FABC  0040        	dw 64  ; CKS - DIR check vector size (DRM+1)/4 (0=fixed disk)
   83 FABE  0002        	dw 2   ; OFF - Reserved tracks
   84                   
   85                   ; Cold boot --------------------------------------------------------------------
   86                   
   87 FAC0  F3          boot:	di
   88 FAC1  31 0100     	ld sp,0100h
   89 FAC4  21 FA00     	ld hl,BIOS
   90 FAC7  22 FFFE     	ld (0FFFEh),hl
   91                   
   92                   	; initialise UART0 to 9600 baud
   93                   
   94 FACA  21 0380     	ld hl,0380h
   95 FACD  11 1A06     	ld de,1A06h
   96 FAD0  ED 21 A5    	db 0EDh,21h,0A5h        ; out0 (0A5h),h = 03h
   97 FAD3  ED 29 C3    	db 0EDh,29h,0C3h        ; out0 (0C3h),l = 80h
   98 FAD6  ED 11 C0    	db 0EDh,11h,0C0h        ; out0 (0C0h),d = 1Ah
   99 FAD9  ED 21 C3    	db 0EDh,21h,0C3h        ; out0 (0C3h),h = 03h
  100 FADC  ED 19 C2    	db 0EDh,19h,0C2h        ; out0 (0C2h),e = 06h
  101                   
  102 FADF  AF          	xor a
  103 FAE0  32 0003     	ld (iobyte),a
  104 FAE3  32 0004     	ld (usrdrv),a
  105 FAE6  18 16       	jr gocpm
  106                   
  107                   ; Warm boot --------------------------------------------------------------------
  108                   
  109 FAE8  F3          wboot:	di
  110 FAE9  31 0100     	ld sp,0100h
  111                   
  112                   	; copy 5.5K from {FROM,FOFF+0100h} to {BANK,CCP} to reload CCP
  113                   
  114 FAEC  5B 21       	db 5Bh,21h              ; ld.lil hl,{FROM,FOFF+0100h}
  115 FAEE  6100        	dw FOFF+0100h
  116 FAF0  3A          	db FROM
  117 FAF1  5B 11       	db 5Bh,11h              ; ld.lil de,{BANK,CCP}
Maximal CPM 2.2 BIOS for eZ80 -jcw, 2017-03-17 Z80ASM 1.32 Page   3
MAXBIOS Z80

  118 FAF3  E400        	dw CCP
  119 FAF5  20          	db BANK
  120 FAF6  5B 01       	db 5Bh,01h              ; ld.lil bc,BIOS-CCP
  121 FAF8  1600        	dw BIOS-CCP
  122 FAFA  00          	db 0
  123 FAFB  49 ED B0    	db 49h,0EDh,0B0h        ; ldir.l
  124                   
  125                   ; Common code for cold and warm boot
  126                   
  127 FAFE  21 0080     gocpm:	ld hl,tpabuf            ; Address of BIOS DMA buffer
  128 FB01  22 FC6C     	ld (dmaadr),hl
  129                   
  130 FB04  CD FC13     	call vinit		; set up SPI for virtual disks
  131                   
  132 FB07  3E C3       	ld a,0C3h               ; Opcode for 'JP'
  133 FB09  32 0000     	LD (00h),a              ; Load at start of RAM
  134 FB0C  21 FA03     	ld hl,wboote            ; Address of jump for a warm boot
  135 FB0F  22 0001     	ld (01h),hl
  136 FB12  32 0005     	ld (05h),a              ; Opcode for 'JP'
  137 FB15  21 EC06     	ld hl,BDOS              ; Address of jump for the BDOS
  138 FB18  22 0006     	ld (06h),hl
  139 FB1B  3A 0004     	ld a,(usrdrv)           ; Save new drive number (0)
  140 FB1E  4F          	ld c,a                  ; Pass drive number in C
  141 FB1F  C3 E400     	jp CCP                  ; Start CP/M by jumping to the CCP
  142                   
  143                   ; Console I/O ------------------------------------------------------------------
  144                   
  145 FB22  ED 38 C5    conist:	db 0EDh,38h,0C5h ; in0 a,(0C5h)
  146 FB25  E6 01       	and 01h
  147 FB27  ED 44       	neg
  148 FB29  C9          	ret
  149                   
  150 FB2A  CD FB22     conin:	call conist
  151 FB2D  28 FB       	jr z,conin
  152 FB2F  ED 38 C0    	db 0EDh,38h,0C0h        ; in0 a,(0C0h)
  153 FB32  C9          	ret
  154                   
  155 FB33  ED 38 C5    conout:	db 0EDh,38h,0C5h        ; in0 a,(0C5h)
  156 FB36  E6 20       	and 20h
  157 FB38  28 F9       	jr z,conout
  158 FB3A  ED 09 C0    	db 0EDh,09h,0C0h        ; out0 (0C0h),c
  159 FB3D  C9          	ret
  160                   
  161 FB3E  3E 1A       reader:	ld a,1Ah
  162 FB40  C9          	ret
  163                   
  164 FB41              listst:
  165 FB41              list:
  166 FB41              punch:
  167 FB41  AF          	xor a
  168 FB42  C9          	ret
  169                   
  170                   ; Disk I/O ---------------------------------------------------------------------
  171                   
  172 FB43  79          seldsk: ld a,c
  173 FB44  FE 06       	cp 6
  174 FB46  30 0F               jr nc,baddsk
  175 FB48  06 10               ld b,16
Maximal CPM 2.2 BIOS for eZ80 -jcw, 2017-03-17 Z80ASM 1.32 Page   4
MAXBIOS Z80

  176 FB4A  ED 4C       	db 0EDh,4Ch ; mlt bc
  177 FB4C  21 FA33             ld hl,dpbase
  178 FB4F  09                  add hl,bc
  179 FB50  32 FC72     savdsk:	ld (sekdsk),a
  180 FB53  22 FC73             ld (sekdpt),hl
  181 FB56  C9                  ret
  182                   
  183 FB57  21 0000     baddsk: ld hl,0
  184 FB5A  3A 0004             ld a,(usrdrv)
  185 FB5D  91                  sub a,c
  186 FB5E  C0                  ret nz
  187 FB5F  32 0004             ld (usrdrv),a
  188 FB62  18 EC               jr savdsk
  189                   
  190 FB64  0E 00       home:	ld c,0
  191 FB66  79          settrk: ld a,c
  192 FB67  32 FC75     	ld (sektrk),a
  193 FB6A  C9                  ret
  194                   
  195 FB6B  ED 43 FC76  setsec: ld (seksec),bc
  196 FB6F  C9                  ret
  197                   
  198 FB70  ED 43 FC6C  setdma: ld (dmaadr),bc
  199 FB74  C9                  ret
  200                   
  201 FB75  69          sectrn: ld l,c
  202 FB76  60          	ld h,b
  203 FB77  C9                  ret
  204                   
  205 FB78  CD FC37     read:	call rwaddr
  206                   
  207 FB7B  FE 03               cp 3
  208 FB7D  30 33               jr nc,vread		; D/E/F: are virtual
  209                   
  210 FB7F  5B 2A       	db 5Bh,2Ah              ; ld.lil hl,({BANK,dskadr})
  211 FB81  FC6F        	dw dskadr
  212 FB83  20          	db BANK
  213 FB84  5B ED 5B    	db 5Bh,0EDh,5Bh         ; ld.lil de,({BANK,dmaadr})
  214 FB87  FC6C        	dw dmaadr
  215 FB89  20          	db BANK
  216                   
  217 FB8A  18 15       	jr rwop
  218                   
  219 FB8C  CD FC37     write:	call rwaddr
  220                   
  221 FB8F  B7                  or a			; A: is writable
  222 FB90  28 04               jr z,wram
  223 FB92  FE 02               cp 2			; C: is also writable
  224 FB94  20 15               jr nz,wother
  225                   
  226 FB96  5B 2A       wram:	db 5Bh,2Ah              ; ld.lil hl,({BANK,dmaadr})
  227 FB98  FC6C        	dw dmaadr
  228 FB9A  20          	db BANK
  229 FB9B  5B ED 5B    	db 5Bh,0EDh,5Bh         ; ld.lil de,({BANK,dskadr})
  230 FB9E  FC6F        	dw dskadr
  231 FBA0  20          	db BANK
  232                   
  233 FBA1  5B 01 80 00 rwop:	db 5Bh,01h,80h,00h,00h  ; ld.lil bc,000080h
Maximal CPM 2.2 BIOS for eZ80 -jcw, 2017-03-17 Z80ASM 1.32 Page   5
MAXBIOS Z80

  234 FBA6  49 ED B0    	db 49h,0EDh,0B0h        ; ldir.l
  235 FBA9  AF          	xor a
  236 FBAA  C9          	ret
  237                   
  238 FBAB  FE 03       wother:	cp 3			; D: is virtual and writable
  239 FBAD  28 1B               jr z,vwrite
  240 FBAF  3E 02       	ld a,2			; disk is read-only
  241 FBB1  C9          	ret
  242                   
  243         009A      PB_DR	equ 9Ah
  244         009B      PB_DDR	equ 9Bh
  245         009C      PB_ALT1	equ 9Ch
  246         009D      PB_ALT2	equ 9Dh
  247                   
  248         00B8      SPI_BRGL equ 0B8h
  249         00B9      SPI_BRGH equ 0B9h
  250         00BA      SPI_CTL  equ 0BAh
  251         00BB      SPI_SR   equ 0BBh
  252         00BC      SPI_TSR  equ 0BCh
  253         00BC      SPI_RBR  equ 0BCh
  254                   
  255                   ; Virtual disk read, disk# in A
  256                   
  257 FBB2  CD FBDD     vread:  call vrwop		; 0..3: request
  258 FBB5  CD FBF5             call vidle		; wait until idle
  259 FBB8  AF          	xor a
  260 FBB9  CD FC07     vread1:	call vxfer		; 0..127: read data
  261 FBBC  77          	ld (hl),a
  262 FBBD  23          	inc hl
  263 FBBE  10 F9       	djnz vread1
  264 FBC0  AF          vdone:	xor a
  265 FBC1  ED 08 9A    vstop:	db 0EDh,08h,PB_DR	; in0 c,(PB_DR)
  266 FBC4  CB C1       	set 0,c			; set NSS high (PB0)
  267 FBC6  ED 09 9A    	db 0EDh,09h,PB_DR	; out0 (PB_DR),c
  268 FBC9  C9                  ret
  269                   
  270                   ; Virtual disk write, disk# in A
  271                   
  272 FBCA  F6 08       vwrite:	or 8			; tag as write request
  273 FBCC  CD FBDD     	call vrwop		; 0..3: request
  274 FBCF  CD FC05     vwrit1:	call vnext		; 4..131: write data
  275 FBD2  10 FB       	djnz vwrit1
  276 FBD4  CD FBF5             call vidle		; wait until idle
  277 FBD7  AF          	xor a
  278 FBD8  CD FC07     	call vxfer		; get write status
  279 FBDB  18 E3       	jr vdone		; TODO should be vstop
  280                   
  281                   ; Common virtual read/write code to send 4-byte request header
  282                   ; Expects request code in A
  283                   ; Returns DMA address in HL, 128 in B
  284                   
  285 FBDD  CD FBF5     vrwop:	call vidle		; wait until idle
  286 FBE0  CD FC07             call vxfer		; 0: write request (seldsk+8)
  287 FBE3  21 FC6F             ld hl,dskadr
  288 FBE6  CD FC05             call vnext		; 1: offset, bits 7..0
  289 FBE9  CD FC05             call vnext		; 2: offset, bits 15..8
  290 FBEC  CD FC05             call vnext		; 3: offset, bits 23..16
  291 FBEF  2A FC6C     	ld hl,(dmaadr)
Maximal CPM 2.2 BIOS for eZ80 -jcw, 2017-03-17 Z80ASM 1.32 Page   6
MAXBIOS Z80

  292 FBF2  06 80       	ld b,128
  293 FBF4  C9          	ret
  294                   
  295 FBF5  CD FBC1     vidle:	call vstop
  296 FBF8  ED 08 9A    vidle1:	db 0EDh,08h,PB_DR	; in0 c,(PB_DR)
  297 FBFB  CB 49       	bit 1,c			; test BUSY (PB1)
  298 FBFD  20 F9       	jr nz,vidle1		; reply is not zero, repeat
  299 FBFF  CB 81       	res 0,c			; set NSS low (PB0)
  300 FC01  ED 09 9A    	db 0EDh,09h,PB_DR	; out0 (PB_DR),c
  301 FC04  C9          	ret
  302                   
  303 FC05  7E          vnext:	ld a,(hl)
  304 FC06  23          	inc hl
  305 FC07  ED 39 BC    vxfer:	db 0EDh,39h,SPI_TSR	; out0 (SPI_TSR),a
  306 FC0A  ED 38 BB    vxfer1:	db 0EDh,38h,SPI_SR	; in0 a,(SPI_SR)
  307 FC0D  28 FB       	jr z,vxfer1
  308 FC0F  ED 38 BC    	db 0EDh,38h,SPI_RBR	; in0 a,(SPI_RBR)
  309 FC12  C9                  ret
  310                   
  311 FC13  3E 89       vinit:	ld a,89h
  312 FC15  ED 39 9A    	db 0EDh,39h,PB_DR	; out0 (PB_DR),a
  313 FC18  3E CE       	ld a,0CEh
  314 FC1A  ED 39 9B    	db 0EDh,39h,PB_DDR	; out0 (PB_DDR),a
  315 FC1D  3E 00       	ld a,00h
  316 FC1F  ED 39 9C    	db 0EDh,39h,PB_ALT1	; out0 (PB_ALT1),a
  317 FC22  3E CC       	ld a,0CCh
  318 FC24  ED 39 9D    	db 0EDh,39h,PB_ALT2	; out0 (PB_ALT2),a
  319 FC27  3E 00       	ld a,00H
  320 FC29  ED 39 B9    	db 0EDh,39h,SPI_BRGH	; out0 (SPI_BRG_H),a
  321 FC2C  3E 03       	ld a,03h
  322 FC2E  ED 39 B8    	db 0EDh,39h,SPI_BRGL	; out0 (SPI_BRG_L),a
  323 FC31  3E 30       	ld a,30h
  324 FC33  ED 39 BA    	db 0EDh,39h,SPI_CTL	; out0 (SPI_CTL),a
  325 FC36  C9          	ret
  326                   
  327                   ; Convert selected disk+track+sector to a memory address
  328                   ; Returns current disk in A, 24-bit address in dskadr[0..2], upper 16-bit in HL
  329                   
  330 FC37  2A FC73     rwaddr:	ld hl,(sekdpt)
  331 FC3A  01 000A             ld bc,10
  332 FC3D  09                  add hl,bc
  333 FC3E  ED 27               db 0EDh,27h             ; ld hl,(hl) ; dpb
  334 FC40  7E                  ld a,(hl)               ; spt
  335 FC41  ED 4B FC75          ld bc,(sektrk)
  336 FC45  47          	ld b,a
  337 FC46  ED 4C       	db 0EDh,4Ch             ; mlt bc
  338                   	; BC = track, converted to linear sector offset
  339 FC48  2A FC76     	ld hl,(seksec)
  340 FC4B  09          	add hl,bc
  341                   	; HL = bits 30..23 of the requested disk block address
  342 FC4C  AF          	xor a
  343 FC4D  CB 1C       	rr h
  344 FC4F  CB 1D       	rr l
  345 FC51  1F          	rra
  346                   	; A = bits 7..0 of the 24-bit disk-block address
  347 FC52  32 FC6F     	ld (dskadr),a
  348                   	; add the disk base to bits 23..16, if drive A: or C:
  349 FC55  3A FC72             ld a,(sekdsk)
Maximal CPM 2.2 BIOS for eZ80 -jcw, 2017-03-17 Z80ASM 1.32 Page   7
MAXBIOS Z80

  350 FC58  B7                  or a
  351 FC59  20 05               jr nz,rwadr1
  352 FC5B  01 3A60     	ld bc,FROM*256+(FOFF/256)   ; A: is RAM disk at (FROM,FOFF)
  353 FC5E  18 07       	jr rwadr2
  354 FC60  FE 02       rwadr1: cp 2			    ; B/D/E/F: do not have an offset
  355 FC62  20 04       	jr nz,rwadr3
  356 FC64  01 23E0     	ld bc,FROM2*256+(FOFF2/256) ; C: is RAM disk at (FROM2,FOFF2)
  357 FC67  09          rwadr2:	add hl,bc
  358 FC68              rwadr3: ; HL = bits 23..8 of the 24-bit disk-block address
  359 FC68  22 FC70     	ld (dskadr+1),hl
  360 FC6B  C9          	ret
  361                   
  362                   ; Data area --------------------------------------------------------------------
  363                   
  364 FC6C  80 00 20    dmaadr: db 80h,00h,BANK ; last dma address + bank
  365                   
  366                   ; End of initialised data
  367                   
  368 FC6F    0003      dskadr: ds 3   ; disk address + bank
  369                   
  370 FC72    0001      sekdsk: ds 1   ; seek disk number
  371 FC73    0002      sekdpt: ds 2   ; seek disk parameter table
  372 FC75    0001      sektrk: ds 1   ; seek track number
  373 FC76    0002      seksec: ds 2   ; seek sector number
  374                   
  375 FC78    0080      dirbuf: ds 128 ; scratch directory area
  376                   
  377 FCF8    002E      alv0:   ds 46  ; allocation vector 0 (max 360 blocks)
  378 FD26    0020      alv1:   ds 32  ; allocation vector 1 (max 255 blocks)
  379 FD46    005B      alv2:   ds 91  ; allocation vector 2 (max 720 blocks)
  380 FDA1    005B      alv3:   ds 91  ; allocation vector 3 (max 720 blocks)
  381 FDFC    005B      alv4:   ds 91  ; allocation vector 4 (max 720 blocks)
  382 FE57    005B      alv5:   ds 91  ; allocation vector 5 (max 720 blocks)
  383                   
  384 FEB2    0040      csv2:   ds 64  ; checksum vector 2 (max 256 dir entries)
  385 FEF2    0040      csv3:   ds 64  ; checksum vector 3 (max 256 dir entries)
  386 FF32    0040      csv4:   ds 64  ; checksum vector 4 (max 256 dir entries)
  387                   
  388         FF72      biosEnd equ $ ; ----------------------------------------------------------------
  389                   
  390                           end
 0 Error(s) Detected.
 1394 Absolute Bytes. 83 Symbols Detected.
