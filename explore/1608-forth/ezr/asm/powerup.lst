# File powerup.asm
0000			; Power-up initialisation code for eZ80 
0000			 
0000			SRAM: equ 0E000h ; starting address of common SRAM 
0000			SIZE: equ 00080h ; size of the power-up init code 
0000			DEST: equ 0E400h ; load and jump to this address 
0000			 
0000			BANK: equ 24h	 ; SRAM and MBASE are set to this bank 
0000			SAVE: equ 25h	 ; original SRAM contents is this bank 
0000			FROM: equ 20h	 ; bank from which to copy everything 
0000			 
0000			    org SRAM 
e000			 
e000			; 1) disable ERAM and move SRAM to BANK 
e000 21 24 80		    ld hl,$8000+BANK 
e003 ed 21 b4		    db 0EDh,21h,0B4h ; out0 (RAM_CTL),h ; disable ERAM 
e006 ed 29 b5		    db 0EDh,29h,0B5h ; out0 (RAM_BANK),l ; SRAM to BANK 
e009			 
e009			; 2) copy 8K SRAM {BANK,SRAM} to {SAVE,SRAM} 
e009 5b 21		    db 5Bh,21h ; ld.lil hl,{BANK,SRAM} 
e00b 00 e0		    dw SRAM 
e00d 24			    db BANK 
e00e 5b 11		    db 5Bh,11h ; ld.lil de,{SAVE,SRAM} 
e010 00 e0		    dw SRAM 
e012 25			    db SAVE 
e013 5b 01		    db 5Bh,01h ; ld.lil bc,002000h 
e015 00 20		    dw 2000h 
e017 00			    db 00h 
e018 49 ed b0		    db 49h,0EDh,0B0h ; ldir.l 
e01b			 
e01b			; 3) copy 6.5K {FROM,0000h} to {BANK,0E380h..0FD80h} 
e01b 5b 21		    db 5Bh,21h ; ld.lil hl,{FROM,0000h} 
e01d 00 00		    dw 0000h 
e01f 20			    db FROM 
e020 5b 11		    db 5Bh,11h ; ld.lil de,{BANK,DEST-SIZE} 
e022 80 e3		    dw DEST-SIZE 
e024 24			    db BANK 
e025 5b 01		    db 5Bh,01h ; ld.lil bc,001A00h 
e027 00 1a		    dw 1A00h 
e029 00			    db 00h 
e02a 49 ed b0		    db 49h,0EDh,0B0h ; ldir.l 
e02d			 
e02d			; 4) room to add more setup code here... 
e02d			 
e02d			; 5) jump to SRAM before changing MBASE (still in A) 
e02d 5b c3		    db 5Bh,0C3h ; jp.lil {BANK,DEST-6} (enters ADL mode) 
e02f fa e3		    dw DEST-6 ; running 0380h higher now, from new copy! 
e031 24			    db BANK 
e032			 
e032 00...		    ds  SRAM+SIZE-$-6 ; take up slack space 
e07a			 
e07a			; 6) change MBASE from ADL mode and fall through to dest 
e07a ed 6d		    db 0EDh,6Dh ; ld  mb,a 
e07c 40 c3		    db 40h,0C3h ; jp.sis DEST (this also exits ADL mode) 
e07e 00 e4		    dw DEST 
e080			 
e080			; ready for use, now running in Z80 mode at {BANK,DEST} 
e080			    end 
# End of file powerup.asm
e080
