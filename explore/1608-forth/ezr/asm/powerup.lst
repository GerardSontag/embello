# File powerup.asm
0000			; Power-up initialisation code for eZ80 
0000			 
0000			SRAM: equ 0E000h ; starting address of common SRAM 
0000			DEST: equ 0E600h ; load to this address 
0000			BIOS: equ 0FD00h ; finish with jump to BIOS cold boot 
0000			LAST: equ 0FFFFh ; last address loaded on power-up 
0000			 
0000			BANK: equ 20h	 ; SRAM and MBASE are set to this bank 
0000			SAVE: equ 21h	 ; original SRAM contents is this bank 
0000			 
0000			; location of RAM disk: 
0000			FROM: equ 3Ah	 ; bank from which to copy everything 
0000			FOFF: equ 6000h	 ; starting page offset in FROM area 
0000			 
0000			; 1) on power-up, this code initially run at 0000h! 
0000			    org DEST 
e600			 
e600			; 2) disable ERAM and move SRAM to BANK 
e600 21 20 80		    ld hl,8000h+BANK 
e603 ed 21 b4		    db 0EDh,21h,0B4h ; out0 (RAM_CTL),h ; disable ERAM 
e606 ed 29 b5		    db 0EDh,29h,0B5h ; out0 (RAM_BANK),l ; SRAM to BANK 
e609			 
e609			; 3) copy 8K SRAM {BANK,SRAM} to {SAVE,SRAM} 
e609 5b 21		    db 5Bh,21h ; ld.lil hl,{BANK,SRAM} 
e60b 00 e0		    dw SRAM 
e60d 20			    db BANK 
e60e 5b 11		    db 5Bh,11h ; ld.lil de,{SAVE,SRAM} 
e610 00 e0		    dw SRAM 
e612 21			    db SAVE 
e613 5b 01		    db 5Bh,01h ; ld.lil bc,002000h 
e615 00 20		    dw 2000h 
e617 00			    db 00h 
e618 49 ed b0		    db 49h,0EDh,0B0h ; ldir.l 
e61b			 
e61b			; 4) copy 6K {FROM,FOFF} to {BANK,DEST..LAST} 
e61b 5b 21		    db 5Bh,21h ; ld.lil hl,{FROM,FOFF} 
e61d 00 60		    dw FOFF 
e61f 3a			    db FROM 
e620 5b 11		    db 5Bh,11h ; ld.lil de,{BANK,DEST} 
e622 00 e6		    dw DEST 
e624 20			    db BANK 
e625 5b 01		    db 5Bh,01h ; ld.lil bc,LAST-DEST+1 
e627 00 1a		    dw LAST-DEST+1 
e629 00			    db 00h 
e62a 49 ed b0		    db 49h,0EDh,0B0h ; ldir.l 
e62d			 
e62d			; 5) jump to SRAM before changing MBASE 
e62d 5b c3		    db 5Bh,0C3h ; jp.lil {BANK,reloc1} (enters ADL mode) 
e62f 32 e6		    dw reloc1 ; continue running at correct origin 
e631 20			    db BANK 
e632			reloc1: 
e632			 
e632			; 6) change MBASE while in ADL mode 
e632 3e 20		    ld a,BANK 
e634 ed 6d		    db 0EDh,6Dh ; ld  mb,a 
e636 40 c3		    db 40h,0C3h ; jp.sis reloc2 (this exits ADL mode) 
e638 3a e6		    dw reloc2 
e63a			reloc2: ; now running in Z80 mode at {BANK,reloc2} 
e63a			 
e63a			; 7) set up PLL and switch system clock to 50 MHz 
e63a			    ; TODO ... 
e63a c3 00 fd		    jp BIOS 
e63d			 
e63d 00...		    ds DEST+0100h-$ 
e700			    end 
# End of file powerup.asm
e700
