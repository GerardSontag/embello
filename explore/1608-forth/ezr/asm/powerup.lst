# File powerup.asm
0000			; Power-up initialisation code for eZ80 
0000			 
0000			SRAM: equ 0E000h ; starting address of common SRAM 
0000			DEST: equ 0E780h ; load to this address 
0000			BIOS: equ 0FE00h ; finish with jump to BIOS cold boot 
0000			 
0000			BANK: equ 20h	 ; SRAM and MBASE are set to this bank 
0000			SAVE: equ 21h	 ; original SRAM contents is this bank 
0000			 
0000			; when booting from flash disk: 
0000			;FROM: equ 00h    ; bank from which to copy everything 
0000			;FOFF: equ 0000h  ; starting page offset in FROM area 
0000			 
0000			; when booting from RAM disk: 
0000			FROM: equ 3Ah	 ; bank from which to copy everything 
0000			FOFF: equ 6000h	 ; starting page offset in FROM area 
0000			 
0000			; 1) on power-up, this code initially run at 0000h! 
0000			    org DEST 
e780			 
e780			; 2) disable ERAM and move SRAM to BANK 
e780 21 20 80		    ld hl,8000h+BANK 
e783 ed 21 b4		    db 0EDh,21h,0B4h ; out0 (RAM_CTL),h ; disable ERAM 
e786 ed 29 b5		    db 0EDh,29h,0B5h ; out0 (RAM_BANK),l ; SRAM to BANK 
e789			 
e789			; 3) copy 8K SRAM {BANK,SRAM} to {SAVE,SRAM} 
e789 5b 21		    db 5Bh,21h ; ld.lil hl,{BANK,SRAM} 
e78b 00 e0		    dw SRAM 
e78d 20			    db BANK 
e78e 5b 11		    db 5Bh,11h ; ld.lil de,{SAVE,SRAM} 
e790 00 e0		    dw SRAM 
e792 21			    db SAVE 
e793 5b 01		    db 5Bh,01h ; ld.lil bc,002000h 
e795 00 20		    dw 2000h 
e797 00			    db 00h 
e798 49 ed b0		    db 49h,0EDh,0B0h ; ldir.l 
e79b			 
e79b			; 4) copy 6.5K {FROM,FOFF} to {BANK,0E380h..0FD80h} 
e79b 5b 21		    db 5Bh,21h ; ld.lil hl,{FROM,FOFF} 
e79d 00 60		    dw FOFF 
e79f 3a			    db FROM 
e7a0 5b 11		    db 5Bh,11h ; ld.lil de,{BANK,DEST} 
e7a2 80 e7		    dw DEST 
e7a4 20			    db BANK 
e7a5 5b 01		    db 5Bh,01h ; ld.lil bc,2*26*80h 
e7a7 00 1a		    dw 2*26*80h 
e7a9 00			    db 00h 
e7aa 49 ed b0		    db 49h,0EDh,0B0h ; ldir.l 
e7ad			 
e7ad			; 5) jump to SRAM before changing MBASE 
e7ad 5b c3		    db 5Bh,0C3h ; jp.lil {BANK,reloc1} (enters ADL mode) 
e7af b2 e7		    dw reloc1 ; continue running at correct origin 
e7b1 20			    db BANK 
e7b2			reloc1: 
e7b2			 
e7b2			; 6) change MBASE while in ADL mode 
e7b2 3e 20		    ld a,BANK 
e7b4 ed 6d		    db 0EDh,6Dh ; ld  mb,a 
e7b6 40 c3		    db 40h,0C3h ; jp.sis reloc2 (this exits ADL mode) 
e7b8 ba e7		    dw reloc2 
e7ba			reloc2: ; now running in Z80 mode at {BANK,reloc2} 
e7ba			 
e7ba			; 7) set up PLL and switch system clock to 50 MHz 
e7ba			    ; TODO ... 
e7ba c3 00 fe		    jp BIOS 
e7bd			 
e7bd			    end 
# End of file powerup.asm
e7bd
